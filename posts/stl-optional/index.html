<!doctype html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="stl-optional 实现" /><meta name="author" content="墨墨鱼" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="剪短的描述" /><meta property="og:description" content="剪短的描述" /><link rel="canonical" href="https://mracli.github.io/posts/stl-optional/" /><meta property="og:url" content="https://mracli.github.io/posts/stl-optional/" /><meta property="og:site_name" content="墨墨鱼的博客" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-08-02T17:13:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="stl-optional 实现" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"墨墨鱼","url":"https://github.com/mracli/"},"dateModified":"2024-08-14T18:13:23+08:00","datePublished":"2024-08-02T17:13:00+08:00","description":"剪短的描述","headline":"stl-optional 实现","mainEntityOfPage":{"@type":"WebPage","@id":"https://mracli.github.io/posts/stl-optional/"},"url":"https://mracli.github.io/posts/stl-optional/"}</script><title>stl-optional 实现 | 墨墨鱼的博客</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="墨墨鱼的博客"><meta name="application-name" content="墨墨鱼的博客"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/favicons/icon.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">墨墨鱼的博客</a></h1><p class="site-subtitle fst-italic mb-0">wubba lubba dub dub</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>关于</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mracli" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['mracli','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首页</a> </span> <span>stl-optional 实现</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>stl-optional 实现</h1><p class="post-desc fw-light mb-4">剪短的描述</p><div class="post-meta text-muted"> <span> 发表于 <time data-ts="1722589980" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024/08/02 </time> </span> <span> 更新于 <time data-ts="1723630403" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024/08/14 </time> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://github.com/mracli/">墨墨鱼</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="741 字" > <em>4 分钟</em>阅读</span></div></div></div></header><div class="content"><p>最近使用 optional 容器，觉得其可以实现返回一个 T 类型或 nullopt 类型的操作挺有意思，这里参考一些内容重新复现该容器。</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre><td class="rouge-code"><pre><span class="c1">// 重新封装 optional 类的异常</span>
<span class="k">class</span> <span class="nc">BadOptionalAccess</span> <span class="o">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">BadOptionalAccess</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">BadOptionalAccess</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">"BadOptionalAccess"</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// 作为无内容时的返回</span>
<span class="k">struct</span> <span class="nc">nullopt_t</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">nullopt_t</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="nc">nullopt_t</span> <span class="n">nullopt</span><span class="p">;</span>

<span class="cm">/* 
 构造 Optional 大部分都是将外部需要存储的 T 类对象/变量 移动到内部

 且构造过程中将移动进的变量进行 placement new 减少一次构造的成本，要记住这里 new 后需要手动析构

 这里面需要注意的是 Optional 重载了乘号运算符，导致直接类内直接使用*可能是地址取值操作，
 所以需要使用 std::addressof(·) 算子取地址

 */</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="k">struct</span> <span class="nc">Optional</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="kt">bool</span> <span class="n">m_has_value</span><span class="p">;</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">m_value</span><span class="p">;</span>
  <span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">Optional</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_has_value</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{};</span>

  <span class="n">Optional</span><span class="p">(</span><span class="n">nullopt_t</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">:</span> <span class="n">m_has_value</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{};</span>

  <span class="n">Optional</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_has_value</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span> <span class="n">m_value</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{};</span>

  <span class="n">Optional</span><span class="p">(</span><span class="n">Optional</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">:</span> <span class="n">m_has_value</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">new</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">))</span> <span class="n">T</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">m_value</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">Optional</span><span class="p">(</span><span class="n">Optional</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_has_value</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">new</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">))</span> <span class="n">T</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">Optional</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">nullopt_t</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
      <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Optional</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">new</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">))</span> <span class="n">T</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">));</span>
    <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Optional</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Optional</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
      <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">m_has_value</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="n">m_value</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Optional</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Optional</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span>
      <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
      <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">m_has_value</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">new</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">))</span> <span class="n">T</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">value</span><span class="p">()));</span>
      <span class="n">that</span><span class="p">.</span><span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
      <span class="n">that</span><span class="p">.</span><span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span><span class="o">...</span> <span class="nc">Args</span><span class="p">&gt;</span>
    <span class="k">requires</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_constructible_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">emplace</span><span class="p">(</span><span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">new</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">))</span> <span class="n">T</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span>
    <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_has_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
      <span class="n">m_has_value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">has_value</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_has_value</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">explicit</span> <span class="k">operator</span> <span class="nf">bool</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">has_value</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">T</span> <span class="o">&amp;&amp;</span><span class="n">value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
      <span class="k">throw</span> <span class="n">BadOptionalAccess</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="k">const</span> <span class="o">&amp;&amp;</span><span class="n">value</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
      <span class="k">throw</span> <span class="n">BadOptionalAccess</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
      <span class="k">throw</span> <span class="n">BadOptionalAccess</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">T</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
      <span class="k">throw</span> <span class="n">BadOptionalAccess</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">T</span> <span class="nf">value_or</span><span class="p">(</span><span class="n">T</span> <span class="n">default_value</span><span class="p">)</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="k">noexcept</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_copy_assignable_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">default_value</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">T</span> <span class="o">&amp;&amp;</span>
  <span class="n">value_or</span><span class="p">(</span><span class="n">T</span> <span class="n">default_value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">noexcept</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_nothrow_move_assignable_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_value</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">default_value</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">value</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">T</span> <span class="k">const</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">T</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="o">&amp;</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">T</span> <span class="k">const</span> <span class="o">&amp;&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="o">&amp;&amp;</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">T</span> <span class="o">&amp;&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_value</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">T</span> <span class="k">const</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">T</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">addressof</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span> <span class="p">}</span>

  <span class="o">~</span><span class="n">Optional</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_value</span><span class="p">())</span>
      <span class="n">m_value</span><span class="p">.</span><span class="o">~</span><span class="n">T</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/c/">C++</a>, <a href="/categories/stl%E5%AE%B9%E5%99%A8/">stl容器</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a> <a href="/tags/stl%E5%AE%B9%E5%99%A8/" class="post-tag no-text-decoration" >stl容器</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=stl-optional%20%E5%AE%9E%E7%8E%B0%20-%20%E5%A2%A8%E5%A2%A8%E9%B1%BC%E7%9A%84%E5%8D%9A%E5%AE%A2&url=https%3A%2F%2Fmracli.github.io%2Fposts%2Fstl-optional%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=stl-optional%20%E5%AE%9E%E7%8E%B0%20-%20%E5%A2%A8%E5%A2%A8%E9%B1%BC%E7%9A%84%E5%8D%9A%E5%AE%A2&u=https%3A%2F%2Fmracli.github.io%2Fposts%2Fstl-optional%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmracli.github.io%2Fposts%2Fstl-optional%2F&text=stl-optional%20%E5%AE%9E%E7%8E%B0%20-%20%E5%A2%A8%E5%A2%A8%E9%B1%BC%E7%9A%84%E5%8D%9A%E5%AE%A2" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="分享链接" data-title-succeed="链接已复制！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/CMU445_proj1/">CMU445 Project 1</a><li class="text-truncate lh-lg"> <a href="/posts/%E9%9D%A2%E8%AF%95/">一些常识性内容的积累</a><li class="text-truncate lh-lg"> <a href="/posts/%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2%E7%AE%97%E6%B3%95/">DH算法及TLS/1.2/1.3握手</a><li class="text-truncate lh-lg"> <a href="/posts/HyperLogLog/">HyperLogLog</a><li class="text-truncate lh-lg"> <a href="/posts/coroutine/">从异步回调到C++20中的协程</a></ul></section><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">C++</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%9F%BA%E7%A1%80/">基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/cmake/">CMake</a> <a class="post-tag btn btn-outline-primary" href="/tags/stl%E5%AE%B9%E5%99%A8/">stl容器</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E6%95%99%E7%A8%8B/">教程</a> <a class="post-tag btn btn-outline-primary" href="/tags/gtest/">GTest</a> <a class="post-tag btn btn-outline-primary" href="/tags/leetcode/">LeetCode</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">相关文章</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/stl-function/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1723275420" data-df="YYYY/MM/DD" > 2024/08/10 </time><h4 class="pt-0 my-2">stl-function 实现</h4><div class="text-muted"><p>剪短的描述</p></div></div></a></article><article class="col"> <a href="/posts/coroutine/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1727595780" data-df="YYYY/MM/DD" > 2024/09/29 </time><h4 class="pt-0 my-2">从异步回调到C++20中的协程</h4><div class="text-muted"><p>虽然C++20有了协程基本件，但还需要自己装修</p></div></div></a></article><article class="col"> <a href="/posts/%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1721801760" data-df="YYYY/MM/DD" > 2024/07/24 </time><h4 class="pt-0 my-2">模板元编程基础</h4><div class="text-muted"><p>剪短的描述</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/%E6%9B%B4%E6%96%B0linux%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7/" class="btn btn-outline-primary" aria-label="上一篇" ><p>更新Linux下的编译工具</p></a> <a href="/posts/%E6%95%B0%E4%BD%8DDP/" class="btn btn-outline-primary" aria-label="下一篇" ><p>数位DP</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://github.com/mracli">墨墨鱼</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。" >保留部分权利。</span></p><p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.0.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">C++</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E5%9F%BA%E7%A1%80/">基础</a> <a class="post-tag btn btn-outline-primary" href="/tags/cmake/">CMake</a> <a class="post-tag btn btn-outline-primary" href="/tags/stl%E5%AE%B9%E5%99%A8/">stl容器</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E6%95%99%E7%A8%8B/">教程</a> <a class="post-tag btn btn-outline-primary" href="/tags/gtest/">GTest</a> <a class="post-tag btn btn-outline-primary" href="/tags/leetcode/">LeetCode</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/zh.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
